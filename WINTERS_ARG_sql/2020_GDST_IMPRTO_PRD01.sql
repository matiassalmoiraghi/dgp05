USE [DYNAMICS]
GO

/****** Object:  StoredProcedure [dbo].[GDST_IMPRTO_PRD01]    Script Date: 28/8/2018 16:34:54 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[GDST_IMPRTO_PRD01]

	@SOPNUMBED									VARCHAR(21)
,	@SOPNUMBEH									VARCHAR(21)	

AS

-- EXEC GDST_IMPRTO_PRD01 'RX A0001-00052204', 'RX A0001-00052204'
IF	(	SELECT
			COUNT(*)
		FROM
			/*
			(SELECT SOPTYPE, SOPNUMBE, DOCID, CUSTNMBR, VOIDSTTS FROM
			PRD01..SOP10100	WHERE SOPTYPE IN(2, 3)
			UNION
			SELECT SOPTYPE, SOPNUMBE, DOCID, CUSTNMBR, VOIDSTTS FROM
			PRD01..SOP30200 WHERE SOPTYPE IN(2, 3))						SP302	*/
			PRD01..SOP10100												SP302
		LEFT OUTER JOIN
			/*
			(SELECT SOPTYPE, SOPNUMBE, LNITMSEQ, ITEMNMBR FROM
			PRD01..SOP10200	WHERE SOPTYPE IN(2, 3)
			UNION
			SELECT SOPTYPE, SOPNUMBE, LNITMSEQ, ITEMNMBR FROM
			PRD01..SOP30300 WHERE SOPTYPE IN(2, 3))						SP303	*/
			PRD01..SOP10200												SP303
		ON
			SP303.SOPTYPE						=	SP302.SOPTYPE
		AND	SP303.SOPNUMBE						=	SP302.SOPNUMBE
--		INNER JOIN
		LEFT OUTER JOIN
			PRD01..SOP10201							SP102
		ON
			SP102.SOPTYPE						=	SP303.SOPTYPE
		AND	SP102.SOPNUMBE						=	SP303.SOPNUMBE
		AND	SP102.LNITMSEQ						=	SP303.LNITMSEQ
--		INNER JOIN
		LEFT OUTER JOIN
			PRD01..IV00101							IV101
		ON
			IV101.ITEMNMBR						=	SP102.ITEMNMBR
--		INNER JOIN
		LEFT OUTER JOIN		
			PRD01..IV00301							IV301
		ON
			IV301.ITEMNMBR						=	SP102.ITEMNMBR
		AND	IV301.LOTNUMBR						=	SP102.SERLTNUM
		INNER JOIN
			PRD01..RM00101							RM101
		ON
			RM101.CUSTNMBR						=	SP302.CUSTNMBR
		AND	RM101.COMMENT1						IN	('ARS' , 'DOL', 'EUR')
		INNER JOIN
			PRD01..SOP40200							SP402
		ON
			SP402.DOCID						=	SP302.DOCID
		WHERE
			SP302.SOPTYPE						IN	( 2,3 )
		AND	SP302.SOPNUMBE						BETWEEN	@SOPNUMBED AND @SOPNUMBEH
		AND	SP302.VOIDSTTS						=	0
		AND SP302.DOCID						LIKE 'RX A%'
	)									=	0
	BEGIN
		SELECT
			'ERROR'								SOPNUMBE
		,	'19000101'							DOCDATE
		,	0								SOPTYPE
		,	0								LNITMSEQ
		,	''								CUSTNMBR
		,	''								CUSTNAME
		,	''								ADDRESS1
		,	''								CITY
		,	''								PROVIN
		,	''								ZIPCODE
		,	''								COUNTRY
		,	'  '
		+	'-'
		+	'        '
		+	'-'
		+	' '								CUIT
		,	''								PHONE
		,	''								PYMTRMID
		,	''								CONDVENTA
		,	0								QUANTITY
		,	'Pieza Nro.: '
		+	' ' + ' - '
		+	' ' + ' // NMC: '
		+	' '								ITEMDESC
		,	'Pieza Cliente: '
		+	''								ITEMCLIE
		,	'OC: '
		+	' '
		+	'.'								ORDNCMPR
		,	' DI Nª:'						MATERIAL
		,	'Remito: '
		+	'        '							REMITO
		,	'19000101'							FECHREMI
		,	0								UNITPRCE
		,	0								ORUNTPRC
		,	0								XTNDPRCE
		,	0								OXTNDPRC
		,	0								PESNETUN
		,	0								PESTOTAL
		,	''								IMPTIT01
		,	0								IMPVAL01
		,	''								IMPTIT02
		,	0								IMPVAL02
		,	''								IMPTIT03
		,	0								IMPVAL03
		,	0								SUBTOTAL
		,	0								ORSUBTOT
		,	0								TAXAMNT
		,	0								ORTAXMNT
		,	0								DOCAMNT
		,	0								ORDOCAMT
		,	''								CURNCYID
		,	0								XCHGRATE
		,	''								CURNCYIM
		,	0								CONTAFAC
		,	'19000101'							DUEDATE
		,	''												SHIPMTHD
		,	''									NOMTRANSP
		,	''									DIRTRANS0
		,	''									DIRTRANSP
		,	''									TELTRANSP
		,	''									HORARIOTRANSP
		,	''												ADDRESS3
		,	''												CSTPONBR 
		,	''													OBSERVACIONES
		,	''											PROVEEDORNRO
		,	''									CONTACTO
	END
ELSE
	BEGIN
		SELECT
			SP302.SOPNUMBE												SOPNUMBE
		,	CONVERT(VARCHAR,SP302.DOCDATE,103)							DOCDATE
		,	SP302.SOPTYPE												SOPTYPE
		,	SP303.LNITMSEQ												LNITMSEQ
		,	SP302.CUSTNMBR												CUSTNMBR
		,	SP302.CUSTNAME												CUSTNAME
		,	RM102.ADDRESS1												ADDRESS1
		,	RM102.CITY													CITY
		,	RM102.STATE													PROVIN
		,	RM102.ZIP													ZIPCODE
		,	RM102.COUNTRY												COUNTRY
		,	SUBSTRING ( LEFT ( SP302.TXRGNNUM , 11 ) , 1 , 2 )
		+	'-'
		+	SUBSTRING ( LEFT ( SP302.TXRGNNUM , 11 ) , 3 , 8 )
		+	'-'
		+	SUBSTRING ( LEFT ( SP302.TXRGNNUM , 11 ) , 11 , 1 )			CUIT
		,	SP302.PHNUMBR1												PHONE
		,	SP302.PYMTRMID												PYMTRMID
		,	ISNULL ( ( SELECT SY039.TXTFIELD FROM PRD01..SY03300 SY033 
						, PRD01..SY03900 SY039 WHERE SY033.PYMTRMID = SP302.PYMTRMID 
						AND SY039.NOTEINDX = SY033.NOTEINDX ) , '' )	CONDVENTA
		,	CASE WHEN IV101.ITEMTYPE >= 3 THEN SP303.QUANTITY ELSE SP102.SERLTQTY END 	QUANTITY
		--,	SP303.QUANTITY
		,	RTRIM ( SP303.ITEMNMBR ) + ' - '
		+	RTRIM ( SP303.ITEMDESC )  									ITEMDESC
		,	RTRIM ( SP102.SERLTNUM )									MATERIAL
		,	ISNULL ( ( SELECT SP603.CUSTITEMNMBR FROM PRD01..SOP60300 SP603 WHERE SP603.ITEMNMBR = SP303.ITEMNMBR AND SP603.CUSTNMBR = SP302.CUSTNMBR ) , '' )
																		ITEMCLIE
		,	SP302.ORIGNUMB												REMITO
--		,	CONVERT(VARCHAR,SP102.DATERECD,103)							FECHREMI
		,	'19000101'													FECHREMI
		,	SP303.UNITPRCE												UNITPRCE
		,	SP303.ORUNTPRC												ORUNTPRC
		,	ROUND ( ( SP102.SERLTQTY * SP303.UNITPRCE ) , 4 )			XTNDPRCE
		,	ROUND ( ( SP102.SERLTQTY * SP303.ORUNTPRC ) , 4 )			OXTNDPRC
		,	'RESP.INSCRIPTO'											IMPTIT01
		,	ISNULL ( ( SELECT SUM ( SP105.STAXAMNT ) 
					FROM PRD01..SOP10105 SP105 
					WHERE SP105.SOPTYPE = SP303.SOPTYPE 
					AND SP105.SOPNUMBE = SP303.SOPNUMBE 
					AND SP105.LNITMSEQ = SP303.LNITMSEQ 
					AND SP105.TAXDTLID IN ('V-IVA 21','V-IVA 10.5') ) , 0 ) 		IMPVAL01
		,	'PERC.II.BB. BS.AS.'										IMPTIT02
		,	ISNULL ( ( SELECT SUM ( SP105.STAXAMNT ) 
					FROM PRD01..SOP10105 SP105 
					WHERE SP105.SOPTYPE = SP303.SOPTYPE 
					AND SP105.SOPNUMBE = SP303.SOPNUMBE 
					AND SP105.LNITMSEQ = SP303.LNITMSEQ 
					AND SP105.TAXDTLID IN ('V-PARBA 00','V-PARBA 01','V-PARBA 02','V-PARBA 03','V-PARBA 04','V-PARBA 05','V-PARBA 06',     
										'V-PARBA 07','V-PARBA 08','V-PARBA 09','V-PARBA 10','V-PARBA 11','V-PARBA 12','V-PARBA 13',     
										'V-PARBA 14','V-PARBA 15') ) , 0 )			IMPVAL02
		,	'EXENTO'													IMPTIT03
		,	ISNULL ( ( SELECT SUM ( SP105.STAXAMNT ) 
						FROM PRD01..SOP10105 SP105 
						WHERE SP105.SOPTYPE = SP303.SOPTYPE 
						AND SP105.SOPNUMBE = SP303.SOPNUMBE 
						AND SP105.LNITMSEQ = SP303.LNITMSEQ 
						AND SP105.TAXDTLID IN ('V-IVA EXENTO') ) , 0 )				IMPVAL03
		,	SP302.SUBTOTAL												SUBTOTAL
		,	SP302.ORSUBTOT												ORSUBTOT
		,	SP302.TAXAMNT												TAXAMNT
		,	SP302.ORTAXAMT												ORTAXMNT
		,	SP302.DOCAMNT												DOCAMNT
		,	SP302.ORDOCAMT												ORDOCAMT
		,	SP302.CURNCYID												CURNCYID
		,	SP302.XCHGRATE												XCHGRATE
		,	RM101.COMMENT1												CURNCYIM
		,	CONVERT ( INT , SP402.COMMNTID )							CONTAFAC
		,	CONVERT(VARCHAR,SP302.DUEDATE,103)							DUEDATE
		,	SP302.SHIPMTHD												SHIPMTHD
		,	ISNULL(SY300.SHMTHDSC, '')									NOMTRANSP
		,	ISNULL(SY300.CARRIER, '')									DIRTRANS0
		,	ISNULL(SY300.CARRACCT, '')									DIRTRANSP
		,	ISNULL(SY300.PHONNAME, '')									TELTRANSP
		,	ISNULL(SY300.CONTACT, '')									HORARIOTRANSP
		,	RM102.ADDRESS3												ADDRESS3
		,	SP302.CSTPONBR												CSTPONBR 
		,	(
			ISNULL(LTRIM(RTRIM(SP106.USERDEF1)), '') + ' ' +
			ISNULL(LTRIM(RTRIM(SP106.USERDEF2)), '') + ' ' +
			ISNULL(LTRIM(RTRIM(SP106.USRDEF03)), '') + ' ' +
			ISNULL(LTRIM(RTRIM(SP106.USRDEF04)), '') + ' ' +
			ISNULL(LTRIM(RTRIM(SP106.USRDEF05)), '')
			)															OBSERVACIONES
		,	RM101.USERDEF1											PROVEEDORNRO
		,	SP302.CNTCPRSN											CONTACTO
		FROM
			PRD01..SOP10100							SP302
		INNER JOIN
			PRD01..SOP10200							SP303
		ON
			SP303.SOPTYPE						=	SP302.SOPTYPE
		AND	SP303.SOPNUMBE						=	SP302.SOPNUMBE
		LEFT OUTER JOIN
			PRD01..SY03000							SY300
		ON
			SY300.SHIPMTHD						=	SP302.SHIPMTHD	
--		INNER JOIN
		LEFT OUTER JOIN
			(SELECT LT.SOPTYPE, LT.SOPNUMBE, LT.LNITMSEQ, LT.ITEMNMBR, LT.SERLTNUM, SUM(SERLTQTY) SERLTQTY FROM
			PRD01..SOP10201 LT WHERE LT.SOPTYPE IN(2, 3)
			GROUP BY LT.SOPTYPE, LT.SOPNUMBE, LT.LNITMSEQ, LT.ITEMNMBR, LT.SERLTNUM) 							SP102
		ON
			SP102.SOPTYPE						=	SP303.SOPTYPE
		AND	SP102.SOPNUMBE						=	SP303.SOPNUMBE
		AND	SP102.LNITMSEQ						=	SP303.LNITMSEQ
--		INNER JOIN
		LEFT OUTER JOIN		
			PRD01..IV00101							IV101
		ON
			IV101.ITEMNMBR						=	SP303.ITEMNMBR
--		INNER JOIN
		LEFT OUTER JOIN
			PRD01..IV00301							IV301
		ON
			IV301.ITEMNMBR						=	SP102.ITEMNMBR
		AND	IV301.LOTNUMBR						=	SP102.SERLTNUM
		INNER JOIN
			PRD01..RM00101							RM101
		ON
			RM101.CUSTNMBR						=	SP302.CUSTNMBR
		AND	RM101.COMMENT1						IN	('ARS' , 'DOL', 'EUR')
		INNER JOIN
			PRD01..SOP40200							SP402
		ON
			SP402.DOCID						=	SP302.DOCID
		LEFT OUTER JOIN
			PRD01..SOP10106							SP106
		ON
			SP302.SOPTYPE						=	SP106.SOPTYPE
		AND	SP302.SOPNUMBE						=	SP106.SOPNUMBE
		INNER JOIN
			PRD01..RM00102							RM102
		ON
			SP302.CUSTNMBR						=	RM102.CUSTNMBR
		AND	SP302.PRSTADCD						=	RM102.ADRSCODE
		
		WHERE
			SP302.SOPTYPE						IN	( 2 , 3)
		AND	SP302.SOPNUMBE						BETWEEN	@SOPNUMBED AND @SOPNUMBEH
		AND	SP302.VOIDSTTS						=	0
		AND SP302.DOCID							LIKE 'RX A%'
		AND ((IV101.ITEMTYPE				<=	2 AND (SP303.QUANTITY						<>	0
		OR ISNULL(SP102.SERLTQTY, 0)			<>	0 ))
				OR IV101.ITEMTYPE				>=	3)
/*   PARA HACER EN EL FUTURO CON LOS CONTABILIZADOS TAMBIEN
	UNION ALL
		SELECT
			SP302.SOPNUMBE												SOPNUMBE
		,	CONVERT(VARCHAR,SP302.DOCDATE,103)							DOCDATE
		,	SP302.SOPTYPE												SOPTYPE
		,	SP303.LNITMSEQ												LNITMSEQ
		,	SP302.CUSTNMBR												CUSTNMBR
		,	SP302.CUSTNAME												CUSTNAME
		,	RM102.ADDRESS1												ADDRESS1
		,	RM102.CITY													CITY
		,	RM102.STATE													PROVIN
		,	RM102.ZIP													ZIPCODE
		,	RM102.COUNTRY												COUNTRY
		,	SUBSTRING ( LEFT ( SP302.TXRGNNUM , 11 ) , 1 , 2 )
		+	'-'
		+	SUBSTRING ( LEFT ( SP302.TXRGNNUM , 11 ) , 3 , 8 )
		+	'-'
		+	SUBSTRING ( LEFT ( SP302.TXRGNNUM , 11 ) , 11 , 1 )			CUIT
		,	SP302.PHNUMBR1												PHONE
		,	SP302.PYMTRMID												PYMTRMID
		,	ISNULL ( ( SELECT SY039.TXTFIELD FROM PRD01..SY03300 SY033 
						, PRD01..SY03900 SY039 WHERE SY033.PYMTRMID = SP302.PYMTRMID 
						AND SY039.NOTEINDX = SY033.NOTEINDX ) , '' )	CONDVENTA
		,	SP102.SERLTQTY												QUANTITY
		,	RTRIM ( SP303.ITEMNMBR ) + ' - '
		+	RTRIM ( SP303.ITEMDESC )  									ITEMDESC
		,	RTRIM ( SP102.SERLTNUM )									MATERIAL
		,	ISNULL ( ( SELECT SP603.CUSTITEMNMBR FROM PRD01..SOP60300 SP603 WHERE SP603.ITEMNMBR = SP303.ITEMNMBR AND SP603.CUSTNMBR = SP302.CUSTNMBR ) , '' )
																		ITEMCLIE
		,	SP302.ORIGNUMB												REMITO
		,	CONVERT(VARCHAR,SP102.DATERECD,103)							FECHREMI
		,	SP303.UNITPRCE												UNITPRCE
		,	SP303.ORUNTPRC												ORUNTPRC
		,	ROUND ( ( SP102.SERLTQTY * SP303.UNITPRCE ) , 4 )			XTNDPRCE
		,	ROUND ( ( SP102.SERLTQTY * SP303.ORUNTPRC ) , 4 )			OXTNDPRC
		,	'RESP.INSCRIPTO'											IMPTIT01
		,	ISNULL ( ( SELECT SUM ( SP105.STAXAMNT ) 
					FROM PRD01..SOP10105 SP105 
					WHERE SP105.SOPTYPE = SP303.SOPTYPE 
					AND SP105.SOPNUMBE = SP303.SOPNUMBE 
					AND SP105.LNITMSEQ = SP303.LNITMSEQ 
					AND SP105.TAXDTLID IN ('V-IVA 21','V-IVA 10.5') ) , 0 ) 		IMPVAL01
		,	'PERC.II.BB. BS.AS.'										IMPTIT02
		,	ISNULL ( ( SELECT SUM ( SP105.STAXAMNT ) 
					FROM PRD01..SOP10105 SP105 
					WHERE SP105.SOPTYPE = SP303.SOPTYPE 
					AND SP105.SOPNUMBE = SP303.SOPNUMBE 
					AND SP105.LNITMSEQ = SP303.LNITMSEQ 
					AND SP105.TAXDTLID IN ('V-PARBA 00','V-PARBA 01','V-PARBA 02','V-PARBA 03','V-PARBA 04','V-PARBA 05','V-PARBA 06',     
										'V-PARBA 07','V-PARBA 08','V-PARBA 09','V-PARBA 10','V-PARBA 11','V-PARBA 12','V-PARBA 13',     
										'V-PARBA 14','V-PARBA 15') ) , 0 )			IMPVAL02
		,	'EXENTO'													IMPTIT03
		,	ISNULL ( ( SELECT SUM ( SP105.STAXAMNT ) 
						FROM PRD01..SOP10105 SP105 
						WHERE SP105.SOPTYPE = SP303.SOPTYPE 
						AND SP105.SOPNUMBE = SP303.SOPNUMBE 
						AND SP105.LNITMSEQ = SP303.LNITMSEQ 
						AND SP105.TAXDTLID IN ('V-IVA EXENTO') ) , 0 )				IMPVAL03
		,	SP302.SUBTOTAL												SUBTOTAL
		,	SP302.ORSUBTOT												ORSUBTOT
		,	SP302.TAXAMNT												TAXAMNT
		,	SP302.ORTAXAMT												ORTAXMNT
		,	SP302.DOCAMNT												DOCAMNT
		,	SP302.ORDOCAMT												ORDOCAMT
		,	SP302.CURNCYID												CURNCYID
		,	SP302.XCHGRATE												XCHGRATE
		,	RM101.COMMENT1												CURNCYIM
		,	CONVERT ( INT , SP402.COMMNTID )							CONTAFAC
		,	CONVERT(VARCHAR,SP302.DUEDATE,103)							DUEDATE
		,	SP302.SHIPMTHD												SHIPMTHD
		,	ISNULL(SY300.SHMTHDSC, '')									NOMTRANSP
		,	ISNULL(SY300.CARRIER, '')									DIRTRANS0
		,	ISNULL(SY300.CARRACCT, '')									DIRTRANSP
		,	ISNULL(SY300.PHONNAME, '')									TELTRANSP
		,	ISNULL(SY300.CONTACT, '')									HORARIOTRANSP
		,	RM102.ADDRESS3												ADDRESS3
		,	SP302.CSTPONBR												CSTPONBR 
		,	(
			ISNULL(LTRIM(RTRIM(SP106.USERDEF1)), '') + ' ' +
			ISNULL(LTRIM(RTRIM(SP106.USERDEF2)), '') + ' ' +
			ISNULL(LTRIM(RTRIM(SP106.USRDEF03)), '') + ' ' +
			ISNULL(LTRIM(RTRIM(SP106.USRDEF04)), '') + ' ' +
			ISNULL(LTRIM(RTRIM(SP106.USRDEF05)), '')
			)															OBSERVACIONES
		,	RM101.USERDEF1											PROVEEDORNRO
		FROM
			PRD01..SOP30200							SP302
		INNER JOIN
			PRD01..SOP30300							SP303
		ON
			SP303.SOPTYPE						=	SP302.SOPTYPE
		AND	SP303.SOPNUMBE						=	SP302.SOPNUMBE
		LEFT OUTER JOIN
			PRD01..SY03000							SY300
		ON
			SY300.SHIPMTHD						=	SP302.SHIPMTHD	
--		INNER JOIN
		LEFT OUTER JOIN
			PRD01..SOP10201							SP102
		ON
			SP102.SOPTYPE						=	SP303.SOPTYPE
		AND	SP102.SOPNUMBE						=	SP303.SOPNUMBE
		AND	SP102.LNITMSEQ						=	SP303.LNITMSEQ
--		INNER JOIN
		LEFT OUTER JOIN		
			PRD01..IV00101							IV101
		ON
			IV101.ITEMNMBR						=	SP102.ITEMNMBR
--		INNER JOIN
		LEFT OUTER JOIN
			PRD01..IV00301							IV301
		ON
			IV301.ITEMNMBR						=	SP102.ITEMNMBR
		AND	IV301.LOTNUMBR						=	SP102.SERLTNUM
		INNER JOIN
			PRD01..RM00101							RM101
		ON
			RM101.CUSTNMBR						=	SP302.CUSTNMBR
		AND	RM101.COMMENT1						IN	('ARS' , 'DOL', 'EUR')
		INNER JOIN
			PRD01..SOP40200							SP402
		ON
			SP402.DOCID						=	SP302.DOCID
		LEFT OUTER JOIN
			PRD01..SOP10106							SP106
		ON
			SP302.SOPTYPE						=	SP106.SOPTYPE
		AND	SP302.SOPNUMBE						=	SP106.SOPNUMBE
		INNER JOIN
			PRD01..RM00102							RM102
		ON
			SP302.CUSTNMBR						=	RM102.CUSTNMBR
		AND	SP302.PRSTADCD						=	RM102.ADRSCODE
		
		WHERE
			SP302.SOPTYPE						IN	( 2 , 3)
		AND	SP302.SOPNUMBE						BETWEEN	@SOPNUMBED AND @SOPNUMBEH
		AND	SP302.VOIDSTTS						=	0
		AND SP302.DOCID							LIKE 'RX A%'
		AND SP303.QUANTITY						<>	0
	*/
		ORDER BY								SP302.SOPTYPE
	,										SP302.SOPNUMBE
	,										SP303.LNITMSEQ
	,										SP102.SERLTNUM
	
	END


GO


